## Oracle PPAS 兼容性分析 之 聚合函数（PARALLEL_ENABLE AGGREGATE）
---

### 一、背景介绍

**1. Oracle基本语法如下:**
```
CREATE [ OR REPLACE ] FUNCTION schema.function_name(params_declaration) RETURN datatype
    PARALLEL_ENABLE AGGREGATE USING schema.implementation_type 
    
-- 其中的implementation_type：必须是User-Defined Aggregate Functions（ADT）用户自定义聚合函数，而且要包含ODCIAggregate子程序的实现。
-- AGGREGATE USING 语法限制：函数尤其只能指定一个输入参数。
```
**ADT函数**
需要通过ODCIAggregate接口进行实现，需要实现 4个 子程序，initialization, iteration, merging, 和 termination。
+ **initialization**：通过 ODCIAggregateInitialize() 程序实现，自定义聚集函数初始化设置,从这儿开始一个聚集函数。
+ **Iteration**：通过 ODCIAggregateIterate() 程序实现，忽略 NULL 值。自定义聚集函数,最主要的步骤,这个函数定义我们的聚集函数具体做什么操作,后面的例子,是取最大值,最小值,平均值,还是做连接操作.self 为当前聚集函数的指针,用来与前面的计算结果进行关联。
+ **merging**：通过 ODCIAggregateMerge() 程序实现，用来合并两个聚集函数的两个不同的指针对应的结果,用户合并不同结果结的数据,特别是处理并行(parallel)查询聚集函数的时候。
+ **termination**：通过 ODCIAggregateTerminate() 程序实现，终止聚集函数的处理,返回聚集函数处理的结果。


**并行处理机制：**

![PARALLEL_ENABLE并行处理](https://docs.oracle.com/cd/B28359_01/appdev.111/b28425/img/addci043.gif)

**2. PPAS/PG基本语法:**
```
CREATE [ OR REPLACE ] FUNCTION  name (argname) RETURNS rettype
  PARALLEL { UNSAFE | RESTRICTED | SAFE }
  
```
**ADT函数**



### 二、转换规则
+ PARALLEL_ENABLE 可以直接转换为 PARALLEL SAFE。

### 三、参考链接
1.[https://docs.oracle.com/cd/E11882_01/appdev.112/e25519/create_function.htm#CIHCAJAF](https://docs.oracle.com/cd/E11882_01/appdev.112/e25519/create_function.htm#CIHCAJAF)
2.[https://docs.oracle.com/cd/B28359_01/appdev.111/b28425/aggr_functions.htm](https://docs.oracle.com/cd/B28359_01/appdev.111/b28425/aggr_functions.htm)
3.[https://www.postgresql.org/docs/10/xaggr.html](https://www.postgresql.org/docs/10/xaggr.html)
